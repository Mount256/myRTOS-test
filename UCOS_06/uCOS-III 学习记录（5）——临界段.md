参考内容：《[野火]uCOS-III内核实现与应用开发实战指南——基于STM32》第 10 章。

[toc]

## 1 临界段

临界段，又叫做临界区。对于多线程而言，它是一段不可分割、不可上下文切换的代码。对于 uCOS 而言，它是一段不可被中断的代码。临界段是不能被中断的，需要关中断或锁调度器（OSSched）以保护临界段。

什么情况下临界段代码会被打断？由刚才的描述可知，临界段被打断有两种情况：
- 外部中断。
- 系统调度。在系统调度中会产生 PendSV 异常中断，最终也可以归结为中断。

因此，**对临界段保护的实质就是控制中断的开启和关闭。**

uCOS 定义了进入临界段的宏和退出临界段的宏，这两个宏分别实现了中断的开启和关闭。
- OS\_CRITICAL\_ENTER() 或 CPU\_CRITICAL\_ENTER()
- OS\_CRITICAL\_EXIT() 或 CPU\_CRITICAL\_EXIT()

还有一个宏，用于存储中断的状态：
- CPU\_SR\_ALLOC()

## 2 临界段的实现 
### 2.1 Cortex-M3 内核的中断指令



## 3 临界段的应用

## 4 测量关中断时间

本部分先忽略，因为还不是我重点关注的部分。待有时间再来研究。

